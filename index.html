<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Search Hub - Pro Edition</title>
    
    <link rel="icon" type="image/png" href="https://www.gstatic.com/youtube/img/branding/favicon/favicon_144x144.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.youtube.com/iframe_api"></script> 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        :root {
            --yt-main: #0f0f0f;
            --yt-surface: #272727;
            --yt-border: #3f3f3f;
        }

        body {
            background-color: var(--yt-main);
            color: #ffffff;
            font-family: 'Assistant', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- Nav Buttons Styling --- */
        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            color: white;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .nav-btn:hover {
            background-color: #3f3f3f;
        }
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: transparent !important;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 250px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--yt-main); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--yt-border); border-radius: 10px; }

        .video-card img { transition: transform 0.3s ease; }
        .video-card:hover img { transform: scale(1.02); border-radius: 8px; }

        /* Watch View (Background Play & Floating Window support) */
        #watchView { 
            display: none; 
            backdrop-filter: blur(12px); 
        }
        #watchView.hidden {
            display: none !important;
        }
        #watchView.active {
            display: flex !important;
        }

        /* --- Floating Player Styles --- */
        #watchView.floating-mode {
            position: fixed;
            top: auto;
            left: 20px;
            bottom: 20px;
            right: auto;
            width: 400px; 
            height: 225px; 
            background: transparent;
            backdrop-filter: none;
            padding: 0;
            z-index: 9999;
            align-items: flex-end;
            justify-content: flex-start;
            pointer-events: none;
        }

        #watchView.floating-mode .modal-overlay-bg {
            display: none; 
        }

        #watchView.floating-mode .player-container {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
            max-height: none !important;
            resize: none;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #333;
            pointer-events: auto;
            display: block; 
            position: relative;
        }

        /* Hide standard elements in floating mode */
        #watchView.floating-mode .player-info-section,
        #watchView.floating-mode .player-header {
            display: none !important;
        }

        /* Make iframe fill container in floating mode */
        #watchView.floating-mode .aspect-video {
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
            padding: 0;
            margin: 0;
        }

        /* Floating Controls (Overlay) */
        .floating-controls {
            display: none;
        }

        #watchView.floating-mode .floating-controls {
            display: flex;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
            justify-content: flex-end;
            gap: 10px;
            cursor: move; 
        }

        #watchView.floating-mode .player-container:hover .floating-controls {
            opacity: 1;
        }

        #configModal { display: none; backdrop-filter: blur(12px); }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px;
            cursor: pointer;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .sidebar-item:hover { background: var(--yt-surface); }
        .sidebar-item.active { background: var(--yt-surface); font-weight: 600; }

        /* Toast Styling */
        .copy-toast {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 10px 20px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .copy-toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }

        /* Progress Bar on Cards */
        .progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.2);
            z-index: 10;
        }
        .progress-bar-fill {
            height: 100%;
            background: #cc0000;
        }
    </style>
</head>
<body class="custom-scrollbar">

    <header class="fixed top-0 left-0 right-0 h-16 bg-[#0f0f0f]/95 border-b border-[#222] flex items-center justify-between px-6 z-[100]">
        <div class="flex items-center gap-5">
            <button class="text-xl p-2 hover:bg-[#272727] rounded-full transition"><i class="fas fa-bars"></i></button>
            <div class="flex items-center gap-1 cursor-pointer" onclick="loadHomePage()">
                <i class="fab fa-youtube text-[#ff0000] text-3xl"></i>
                <span class="text-xl font-bold tracking-tight text-white hidden md:inline">YouTube</span>
            </div>
        </div>

        <div class="flex items-center gap-2 mx-4" dir="ltr">
            <button id="navBackBtn" class="nav-btn" onclick="handleHistoryNav(-1)" title="אחורה" disabled>
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="navForwardBtn" class="nav-btn" onclick="handleHistoryNav(1)" title="קדימה" disabled>
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div class="flex-1 max-w-3xl flex items-center gap-2 px-4">
            <div class="flex w-full group">
                <input type="text" id="searchInput" placeholder="חיפוש" 
                    class="w-full bg-[#121212] border border-[#303030] rounded-r-full py-2.5 px-5 focus:border-blue-500 outline-none transition text-right text-white">
                <button onclick="performSearch(false)" 
                    class="bg-[#222222] border border-[#303030] border-r-0 rounded-l-full px-6 hover:bg-[#2a2a2a] transition">
                    <i class="fas fa-search text-gray-300"></i>
                </button>
            </div>
            
            <select id="searchType" class="bg-[#121212] border border-[#303030] text-white text-sm rounded-lg p-2.5 outline-none hidden md:block" title="סוג תוצאה">
                <option value="">הכל</option>
                <option value="video">סרטונים</option>
                <option value="channel">ערוצים</option>
                <option value="playlist">פלייליסטים</option> </select>
            
            <select id="searchDuration" class="bg-[#121212] border border-[#303030] text-white text-sm rounded-lg p-2.5 outline-none hidden md:block" title="משך">
                <option value="">כל אורך</option>
                <option value="short">קצר (<4 דק')</option>
                <option value="medium">בינוני (4-20 דק')</option>
                <option value="long">ארוך (>20 דק')</option>
            </select>

            <select id="searchOrder" class="bg-[#121212] border border-[#303030] text-white text-sm rounded-lg p-2.5 outline-none hidden md:block" title="סינון לפי">
                <option value="relevance">רלוונטיות</option>
                <option value="date">תאריך העלאה</option>
                <option value="viewCount">מספר צפיות</option>
            </select>
        </div>

        <div class="flex items-center gap-4">
            <button id="return-to-video-btn" class="text-white hover:text-blue-400 p-2 px-3 rounded-full hidden transition-colors bg-[#272727] border border-[#333]" title="חזור לסרטון">
                <i class="fa-solid fa-tv"></i>
            </button>
            <button id="global-pause-btn" class="text-gray-400 hover:text-white p-2 w-10 h-10 flex items-center justify-center rounded-full hidden transition-colors border border-transparent hover:border-[#333]" title="השהה/נגן">
                <i class="fa-solid fa-pause"></i>
            </button>

            <button onclick="toggleConfig()" class="p-2 hover:bg-[#272727] rounded-full transition text-gray-400" title="הגדרות API וגוגל">
                <i class="fas fa-cog text-xl"></i>
            </button>
            
            <div id="authContainer">
                <button onclick="requestToken()" class="bg-[#272727] hover:bg-[#3f3f3f] px-4 py-2 rounded-full text-sm font-bold border border-[#444] transition">
                    התחברות
                </button>
            </div>
            
            <div id="userDisplay" class="hidden flex items-center gap-3">
                <span id="userName" class="text-xs font-bold hidden md:inline text-gray-400"></span>
                <img id="userImg" class="w-8 h-8 rounded-full border border-gray-600">
                <button onclick="handleLogout()" class="p-2 hover:bg-[#272727] rounded-full transition text-red-500" title="התנתק">
                    <i class="fas fa-sign-out-alt text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="flex pt-16 min-h-screen">
        <aside class="w-64 fixed right-0 top-16 bottom-0 hidden lg:block bg-[#0f0f0f] border-l border-[#222] p-4 overflow-y-auto custom-scrollbar">
            <nav class="space-y-1">
                <div onclick="loadHomePage()" class="sidebar-item active" id="navHome">
                    <i class="fas fa-house text-lg"></i><span>דף הבית</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-bolt text-lg"></i><span>Shorts</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-layer-group text-lg"></i><span>מנויים</span>
                </div>
                <hr class="my-3 border-[#222]">
                <div onclick="loadWatchHistory()" class="sidebar-item" id="navHistory">
                    <i class="fas fa-history text-lg"></i><span>היסטוריית צפייה</span>
                </div>
                <div onclick="loadContinueWatching()" class="sidebar-item" id="navContinueWatching">
                    <i class="fas fa-step-forward text-lg"></i><span>המשך צפייה</span>
                </div>
                <div onclick="loadLocalHistory()" class="sidebar-item" id="navLocalHistory">
                    <i class="fas fa-hdd text-lg"></i><span>היסטוריה מקומית (PC)</span>
                </div>
                <div onclick="loadLikedVideos()" class="sidebar-item" id="navLiked">
                    <i class="fas fa-thumbs-up text-lg"></i><span>סרטונים שאהבתי</span>
                </div>
                
                <hr class="my-3 border-[#222]">
                <div class="px-4 py-2 text-xs font-bold text-gray-500 uppercase">הרשימות שלי</div>
                <div id="playlistsNavContainer">
                    </div>
                <div onclick="const n=prompt('שם הרשימה החדשה:'); if(n) PlaylistManager.createPlaylist(n);" class="sidebar-item text-blue-400">
                    <i class="fas fa-plus text-lg"></i><span>צור רשימה חדשה</span>
                </div>
            </nav>
            
            <div class="mt-8">
                <h4 class="px-3 text-xs font-bold text-gray-500 mb-4 uppercase tracking-wider text-right">ניתוח נתונים</h4>
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
        </aside>

        <main class="flex-1 lg:mr-64 p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="sectionTitle" class="text-2xl font-bold hidden">מומלצים</h2>
                <button id="exportUrlsBtn" onclick="downloadUrls()" class="hidden bg-[#222] hover:bg-[#333] text-white px-4 py-2 rounded-lg text-sm font-bold border border-[#444] transition flex items-center gap-2">
                    <i class="fas fa-file-download"></i> הורד כתובות
                </button>
            </div>
            
            <div id="channelFilterContainer" class="hidden mb-6 flex gap-2"></div>

            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                <div class="col-span-full flex flex-col items-center justify-center py-32 opacity-20 text-center">
                    <i class="fab fa-youtube text-[120px] mb-6"></i>
                    <h3 class="text-2xl font-bold italic">ברוכים הבאים ל-YouTube Search Hub</h3>
                    <p class="text-sm mt-2">הגדר מפתח API כדי להתחיל לחקור</p>
                </div>
            </div>

            <div id="pagination" class="hidden mt-12 mb-20 flex justify-center">
                <button id="loadMoreBtn" onclick="performSearch(true)" 
                    class="bg-white text-black px-12 py-3 rounded-full font-bold hover:bg-gray-200 transition shadow-lg">
                    טען תוצאות נוספות
                </button>
            </div>
        </main>
    </div>

    <div id="watchView" class="fixed inset-0 z-[200] items-center justify-center p-4 bg-black/90">
        <div class="absolute inset-0 modal-overlay-bg" onclick="minimizePlayer()"></div>
        
        <div class="player-container relative bg-[#0f0f0f] w-full max-w-5xl max-h-[90vh] rounded-3xl overflow-hidden flex flex-col border border-[#333] shadow-2xl z-10">
            
            <div class="floating-controls">
                 <button onclick="toggleFloatingMode()" class="w-8 h-8 bg-black/60 hover:bg-[#cc0000] text-white rounded-full flex items-center justify-center transition" title="חזור למסך רגיל">
                    <i class="fas fa-expand-alt text-xs"></i>
                </button>
                <button onclick="closePlayer()" class="w-8 h-8 bg-black/60 hover:bg-[#cc0000] text-white rounded-full flex items-center justify-center transition" title="סגור">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>

            <div class="player-header p-4 flex justify-between items-center border-b border-[#222]">
                <h3 id="modalTitle" class="font-bold text-lg truncate px-2"></h3>
                <div class="flex gap-2">
                    <button onclick="toggleExternalPip()" class="w-10 h-10 hover:bg-[#272727] rounded-full flex items-center justify-center transition" title="פתח בחלון צף חיצוני (PiP)">
                        <i class="fas fa-external-link-alt text-gray-400"></i>
                    </button>
                    <button onclick="toggleFloatingMode()" class="w-10 h-10 hover:bg-[#272727] rounded-full flex items-center justify-center transition" title="נגן צף באתר">
                        <i class="fas fa-clone text-gray-400"></i>
                    </button>
                    <button onclick="minimizePlayer()" class="w-10 h-10 hover:bg-[#272727] rounded-full flex items-center justify-center transition" title="מזער והמשך לשמוע ברקע">
                        <i class="fas fa-compress text-gray-400"></i>
                    </button>
                    <button onclick="closePlayer()" class="w-10 h-10 hover:bg-[#272727] rounded-full flex items-center justify-center transition" title="סגור נגן">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
                <div class="aspect-video w-full bg-black flex-shrink-0 relative">
                    <iframe id="playerFrame" class="w-full h-full absolute inset-0" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                </div>
                <div class="p-8 player-info-section">
                    <div class="flex justify-between items-start mb-4">
                        <h2 id="fullTitle" class="text-2xl font-bold flex-1"></h2>
                        <div class="flex gap-2 ml-4">
                             <button id="playerContinueBtn" onclick="toggleContinueWatching()" class="w-12 h-12 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition text-gray-400" title="הוסף להמשך צפייה">
                                <i class="far fa-bookmark text-xl"></i>
                            </button>

                            <button id="playerLikeBtn" onclick="toggleLocalLike()" class="w-12 h-12 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition text-gray-400" title="אהבתי">
                                <i class="far fa-heart text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-[#222] p-5 rounded-2xl">
                        <p id="modalStats" class="text-sm font-bold mb-3 text-gray-300"></p>
                        <div id="modalDesc" class="text-sm text-gray-400 whitespace-pre-wrap leading-relaxed"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="configModal" class="fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4">
        <div class="bg-[#1a1a1a] p-8 rounded-3xl w-full max-w-md border border-[#333] shadow-2xl">
            <h2 class="text-2xl font-bold mb-2 text-center text-white">הגדרות מערכת</h2>
            <p class="text-gray-500 text-xs text-center mb-6">כאן תוכל לעדכן את מפתחות הגישה שלך</p>
            <div class="space-y-5 text-right">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest">YouTube Data API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-[#0f0f0f] border border-[#333] rounded-xl py-3 px-4 outline-none focus:border-red-600 transition text-white">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Google Client ID</label>
                    <input type="text" id="clientIdInput" class="w-full bg-[#0f0f0f] border border-[#333] rounded-xl py-3 px-4 outline-none focus:border-blue-600 transition text-white">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest">תוצאות בכל עמוד (1-50)</label>
                    <input type="number" id="maxResultsInput" min="1" max="50" value="12" class="w-full bg-[#0f0f0f] border border-[#333] rounded-xl py-3 px-4 outline-none focus:border-green-600 transition text-white">
                </div>

                <div class="mt-4 border-t border-[#333] pt-4">
                    <h3 class="text-sm font-bold text-gray-400 mb-3">ניהול נתונים (גיבוי ושחזור)</h3>
                    <div class="flex gap-3">
                        <button onclick="exportData()" class="flex-1 bg-[#222] hover:bg-[#333] text-white py-2 rounded-lg text-xs font-bold border border-[#444] transition">
                            <i class="fas fa-download mb-1 block"></i> ייצוא נתונים
                        </button>
                        <label class="flex-1 bg-[#222] hover:bg-[#333] text-white py-2 rounded-lg text-xs font-bold border border-[#444] cursor-pointer text-center transition">
                            <i class="fas fa-upload mb-1 block"></i> ייבוא נתונים
                            <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="saveAndStart()" class="flex-1 bg-white text-black py-4 rounded-xl font-bold hover:bg-gray-200 transition">שמור והפעל</button>
                    <button onclick="toggleConfig()" class="px-6 bg-[#222] text-white py-4 rounded-xl font-bold transition">ביטול</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="copy-toast">הקישור הועתק ללוח!</div>

    <script>
        let appState = {
            apiKey: "",
            clientId: "",
            pageToken: "",
            query: "",
            chart: null,
            token: null,
            tokenClient: null,
            searchContext: 'general',
            currentVideoId: null,
            currentVideoIndex: -1, // NEW: Track index for autoplay
            currentVideoDetails: null, 
            isVideoPaused: false,
            isFloating: false,
            activeChannelId: null,
            currentRenderedItems: [],
            maxResults: 12,
            progressInterval: null 
        };

        // --- YouTube Player API ---
        let ytPlayer = null;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('playerFrame', {
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            // YT.PlayerState.ENDED = 0
            if (event.data === 0) {
                stopProgressTracking();
                playNextVideo(); // Trigger next video
            }
            // Playing = 1
            else if (event.data === 1) { 
                appState.isVideoPaused = false;
                document.getElementById('global-pause-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
                startProgressTracking();
            } 
            // Paused = 2
            else if (event.data === 2) { 
                appState.isVideoPaused = true;
                document.getElementById('global-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
                saveCurrentProgress(); 
                stopProgressTracking();
            }
        }

        // --- Progress Tracking Logic ---
        function startProgressTracking() {
            stopProgressTracking(); // Clear existing
            appState.progressInterval = setInterval(() => {
                saveCurrentProgress();
            }, 5000); // Save every 5 seconds
        }

        function stopProgressTracking() {
            if (appState.progressInterval) {
                clearInterval(appState.progressInterval);
                appState.progressInterval = null;
            }
        }

        function saveCurrentProgress() {
            if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function' && appState.currentVideoId) {
                const time = Math.floor(ytPlayer.getCurrentTime());
                if (time > 5) { // Only save if watched more than 5 seconds
                    LocalContinueWatchingManager.updateProgress(appState.currentVideoId, time);
                }
            }
        }

        // --- NEW: Autoplay Logic based on Index ---
        function playNextVideo() {
            if (!appState.currentRenderedItems || appState.currentVideoIndex === -1) return;

            // Check if there is a next item
            const nextIndex = appState.currentVideoIndex + 1;
            if (nextIndex < appState.currentRenderedItems.length) {
                const nextItem = appState.currentRenderedItems[nextIndex];
                const nextId = nextItem.id?.videoId || (typeof nextItem.id === 'string' ? nextItem.id : null);
                
                if (nextId) {
                    const snip = nextItem.snippet;
                    // Toast
                    const toast = document.getElementById('toast');
                    toast.innerText = "מנגן את הסרטון הבא...";
                    toast.className = "copy-toast show";
                    setTimeout(() => { toast.className = "copy-toast"; }, 2000);

                    // Pass the index to keep the chain going
                    openPlayer(nextId, snip.title, snip.thumbnails?.high?.url, snip.channelTitle, nextItem.contentDetails?.duration, nextIndex);
                }
            }
        }

        // --- משתני ניהול היסטוריה ---
        let navHistory = [];
        let navIndex = -1;
        let isInternalNav = false; 

        function pushHistory(state) {
            if (isInternalNav) return;
            if (navIndex < navHistory.length - 1) navHistory = navHistory.slice(0, navIndex + 1);
            const currentState = navHistory[navIndex];
            if (currentState && JSON.stringify(currentState) === JSON.stringify(state)) return;
            navHistory.push(state);
            navIndex++;
            updateNavUI();
        }

        function handleHistoryNav(direction) {
            const newIndex = navIndex + direction;
            if (newIndex >= 0 && newIndex < navHistory.length) {
                navIndex = newIndex;
                const state = navHistory[navIndex];
                isInternalNav = true; 
                restoreState(state);
                isInternalNav = false;
                updateNavUI();
            }
        }

        function updateNavUI() {
            const backBtn = document.getElementById('navBackBtn');
            const fwdBtn = document.getElementById('navForwardBtn');
            if(backBtn) backBtn.disabled = (navIndex <= 0);
            if(fwdBtn) fwdBtn.disabled = (navIndex >= navHistory.length - 1);
        }

        function restoreState(state) {
            appState.searchContext = state.context || 'general';
            document.getElementById('channelFilterContainer').classList.add('hidden'); 
            
            if (state.type === 'home') {
                document.getElementById('searchInput').value = "";
                loadHomePage(true);
            } else if (state.type === 'search') {
                document.getElementById('searchInput').value = state.query;
                document.getElementById('searchType').value = state.filterType || '';
                document.getElementById('searchOrder').value = state.order || 'relevance';
                document.getElementById('searchDuration').value = state.duration || '';
                performSearch(false, true); 
            } else if (state.type === 'channel') {
                loadChannelVideos(state.channelId, false, true); 
            } else if (state.type === 'history') {
                loadWatchHistory(true);
            } else if (state.type === 'local_history') {
                loadLocalHistory(true);
            } else if (state.type === 'playlist') {
                loadPlaylistView(state.playlistName, true);
            } else if (state.type === 'liked') { 
                loadLikedVideos(true);
            } else if (state.type === 'continue_watching') {
                loadContinueWatching(true);
            }
        }

        // --- Helper Functions ---
        function formatCount(num) {
            const n = parseInt(num);
            if (!n) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return "לפני " + Math.floor(interval) + " שנים";
            interval = seconds / 2592000;
            if (interval > 1) return "לפני " + Math.floor(interval) + " חודשים";
            interval = seconds / 86400;
            if (interval > 1) return "לפני " + Math.floor(interval) + " ימים";
            interval = seconds / 3600;
            if (interval > 1) return "לפני " + Math.floor(interval) + " שעות";
            interval = seconds / 60;
            if (interval > 1) return "לפני " + Math.floor(interval) + " דקות";
            return "ממש עכשיו";
        }

        function linkify(text) {
            let safeText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return safeText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors">$1</a>');
        }

        function parseDuration(duration) {
            if (!duration) return "";
            const matches = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!matches) return "";
            const hours = (matches[1] || '').replace('H', '');
            const minutes = (matches[2] || '').replace('M', '');
            const seconds = (matches[3] || '').replace('S', '');
            
            let result = [];
            if (hours) result.push(hours);
            result.push(minutes ? (minutes.length === 1 && hours ? '0' + minutes : minutes) : (hours ? '00' : '0'));
            result.push(seconds ? (seconds.length === 1 ? '0' + seconds : seconds) : '00');
            
            return result.join(':');
        }

        function parseDurationToSeconds(duration) {
            if (!duration) return 0;
            const matches = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!matches) return 0;
            const hours = parseInt((matches[1] || '').replace('H', '')) || 0;
            const minutes = parseInt((matches[2] || '').replace('M', '')) || 0;
            const seconds = parseInt((matches[3] || '').replace('S', '')) || 0;
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        function downloadUrls() {
            if (!appState.currentRenderedItems || appState.currentRenderedItems.length === 0) {
                alert('אין תוצאות להורדה כרגע.');
                return;
            }

            let urlsText = "";
            appState.currentRenderedItems.forEach(item => {
                let url = "";
                let title = item.snippet?.title || "Unknown";
                
                if (item.id.videoId) {
                    url = `https://www.youtube.com/watch?v=${item.id.videoId}`;
                } else if (item.id.playlistId) {
                    url = `https://www.youtube.com/playlist?list=${item.id.playlistId}`;
                } else if (item.id.channelId) {
                    url = `https://www.youtube.com/channel/${item.id.channelId}`;
                } else if (typeof item.id === 'string') { // Fallback
                    url = `https://www.youtube.com/watch?v=${item.id}`;
                }

                if (url) {
                    urlsText += `${title} - ${url}\n`;
                }
            });

            const blob = new Blob([urlsText], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.href = window.URL.createObjectURL(blob);
            anchor.download = `youtube_urls_${new Date().getTime()}.txt`;
            anchor.click();
            window.URL.revokeObjectURL(anchor.href);
        }

        // --- Playlist & Local Storage Logic ---
        const PlaylistManager = {
            getPlaylists: () => JSON.parse(localStorage.getItem('yt_playlists') || '{"Watch Later": []}'),
            
            savePlaylists: (playlists) => localStorage.setItem('yt_playlists', JSON.stringify(playlists)),
            
            createPlaylist: (name) => {
                if (!name) return;
                const playlists = PlaylistManager.getPlaylists();
                if (playlists[name]) return alert('רשימה זו כבר קיימת');
                playlists[name] = [];
                PlaylistManager.savePlaylists(playlists);
                loadPlaylistsToSidebar(); 
            },

            renamePlaylist: (oldName, newName) => {
                if (!newName || oldName === newName) return;
                const playlists = PlaylistManager.getPlaylists();
                if (playlists[newName]) return alert('שם זה כבר קיים לרשימה אחרת');
                
                playlists[newName] = playlists[oldName];
                delete playlists[oldName];
                PlaylistManager.savePlaylists(playlists);
                loadPlaylistsToSidebar();
                loadPlaylistView(newName); // טען מחדש עם השם החדש
            },

            deletePlaylist: (name) => {
                if (!confirm(`האם אתה בטוח שברצונך למחוק את הרשימה "${name}"?`)) return;
                const playlists = PlaylistManager.getPlaylists();
                delete playlists[name];
                PlaylistManager.savePlaylists(playlists);
                loadPlaylistsToSidebar();
                loadHomePage(); // חזור לדף הבית
            },

            addToPlaylist: (playlistName, video) => {
                const playlists = PlaylistManager.getPlaylists();
                if (!playlists[playlistName]) playlists[playlistName] = [];
                
                // בדיקה אם הסרטון כבר קיים
                if (playlists[playlistName].some(v => v.id === video.id)) {
                    return alert('הסרטון כבר נמצא ברשימה זו');
                }
                
                playlists[playlistName].push({
                    id: video.id,
                    title: video.title,
                    thumbnail: video.thumbnail,
                    channel: video.channel,
                    duration: video.duration,
                    addedAt: new Date().toISOString()
                });
                PlaylistManager.savePlaylists(playlists);
                
                // Toast הודעה
                const toast = document.getElementById('toast');
                toast.innerText = `נוסף ל-${playlistName === 'Watch Later' ? 'צפייה בהמשך' : playlistName}`;
                toast.className = "copy-toast show";
                setTimeout(() => { toast.className = "copy-toast"; toast.innerText = "הקישור הועתק ללוח!"; }, 3000);
            },

            removeFromPlaylist: (playlistName, videoId) => {
                const playlists = PlaylistManager.getPlaylists();
                if (playlists[playlistName]) {
                    playlists[playlistName] = playlists[playlistName].filter(v => v.id !== videoId);
                    PlaylistManager.savePlaylists(playlists);
                    loadPlaylistView(playlistName, true); // רענון תצוגה
                }
            }
        };

        // --- מנהל לייקים מקומי ---
        const LocalLikesManager = {
            getLikes: () => JSON.parse(localStorage.getItem('yt_local_likes') || '[]'),
            
            isLiked: (videoId) => {
                const likes = LocalLikesManager.getLikes();
                return likes.some(v => v.id === videoId);
            },
            
            toggleLike: (video) => {
                let likes = LocalLikesManager.getLikes();
                const existingIndex = likes.findIndex(v => v.id === video.id);
                
                if (existingIndex > -1) {
                    likes.splice(existingIndex, 1);
                    localStorage.setItem('yt_local_likes', JSON.stringify(likes));
                    return false; // Removed
                } else {
                    likes.unshift({
                        id: video.id,
                        title: video.title,
                        thumbnail: video.thumbnail,
                        channel: video.channel,
                        duration: video.duration,
                        addedAt: new Date().toISOString()
                    });
                    localStorage.setItem('yt_local_likes', JSON.stringify(likes));
                    return true; // Added
                }
            }
        };

        // --- מנהל המשך צפייה (מעודכן: פורמט URL) ---
        const LocalContinueWatchingManager = {
            getList: () => JSON.parse(localStorage.getItem('yt_continue_watching') || '[]'),
            
            isInList: (videoId) => {
                const list = LocalContinueWatchingManager.getList();
                return list.some(v => v.id === videoId);
            },

            getTimeFromUrl: (videoId) => {
                const list = LocalContinueWatchingManager.getList();
                const item = list.find(v => v.id === videoId);
                if (item && item.resumeUrl) {
                    // Extract ?t=123
                    const match = item.resumeUrl.match(/[?&]t=(\d+)/);
                    if (match) return parseInt(match[1]);
                }
                return item ? (item.timestamp || 0) : 0;
            },
            
            toggle: (video) => {
                let list = LocalContinueWatchingManager.getList();
                const existingIndex = list.findIndex(v => v.id === video.id);
                
                if (existingIndex > -1) {
                    list.splice(existingIndex, 1);
                    localStorage.setItem('yt_continue_watching', JSON.stringify(list));
                    return false; // Removed
                } else {
                    list.unshift({
                        id: video.id,
                        title: video.title,
                        thumbnail: video.thumbnail,
                        channel: video.channel,
                        duration: video.duration,
                        timestamp: 0,
                        resumeUrl: `https://youtu.be/${video.id}?t=0`, // Save exact format
                        addedAt: new Date().toISOString()
                    });
                    localStorage.setItem('yt_continue_watching', JSON.stringify(list));
                    return true; // Added
                }
            },

            updateProgress: (videoId, time) => {
                let list = LocalContinueWatchingManager.getList();
                const index = list.findIndex(v => v.id === videoId);
                if (index > -1) {
                    list[index].timestamp = time;
                    // Update URL with new time
                    list[index].resumeUrl = `https://youtu.be/${videoId}?t=${time}`;
                    localStorage.setItem('yt_continue_watching', JSON.stringify(list));
                }
            }
        };

        function toggleContinueWatching() {
             if (!appState.currentVideoId || !appState.currentVideoDetails) return;
            
            const isAdded = LocalContinueWatchingManager.toggle(appState.currentVideoDetails);
            updateContinueButtonUI(isAdded);
            
            if (appState.searchContext === 'continue_watching') {
                loadContinueWatching(true);
            }
            
            // Toast
            const toast = document.getElementById('toast');
            toast.innerText = isAdded ? 'נוסף להמשך צפייה' : 'הוסר מהמשך צפייה';
            toast.className = "copy-toast show";
            setTimeout(() => { toast.className = "copy-toast"; }, 3000);
        }

        function updateContinueButtonUI(isAdded) {
            const btn = document.getElementById('playerContinueBtn');
            const icon = btn.querySelector('i');
            if (isAdded) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.classList.add('text-blue-400');
                btn.classList.add('text-white');
            } else {
                icon.classList.remove('fas');
                icon.classList.remove('text-blue-400');
                icon.classList.add('far');
                btn.classList.remove('text-white');
            }
        }

        function loadContinueWatching(isHistoryNav = false) {
            setActiveNavItem('navContinueWatching');
            appState.searchContext = 'continue_watching';
            document.getElementById('channelFilterContainer').classList.add('hidden');
            
            if (!isHistoryNav) pushHistory({ type: 'continue_watching' });

            const titleEl = document.getElementById('sectionTitle');
            titleEl.innerText = "המשך צפייה";
            titleEl.classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
            
            if (appState.currentVideoId) minimizePlayer();

            const list = LocalContinueWatchingManager.getList();

            if (list.length === 0) {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">הרשימה ריקה.<br>סמן סרטונים בסימניה כדי לשמור אותם כאן.</div>';
                appState.currentRenderedItems = [];
                return;
            }

            const formattedItems = list.map(item => ({
                id: { kind: 'youtube#video', videoId: item.id },
                snippet: {
                    title: item.title,
                    channelTitle: item.channel,
                    thumbnails: { high: { url: item.thumbnail }, medium: { url: item.thumbnail } },
                    publishedAt: item.addedAt
                },
                contentDetails: { duration: item.duration },
                statistics: { viewCount: 0 },
                timestamp: item.timestamp // Pass timestamp for rendering
            }));

            renderResults(formattedItems, true);
        }

        // --- פונקציה לשינוי מצב לייק ---
        function toggleLocalLike() {
            if (!appState.currentVideoId || !appState.currentVideoDetails) return;
            
            const isLiked = LocalLikesManager.toggleLike(appState.currentVideoDetails);
            updateLikeButtonUI(isLiked);
            
            if (appState.searchContext === 'liked') {
                loadLikedVideos(true);
            }
        }

        // פונקציה: החלפת מצב לייק מכרטיסיית סרטון
        function toggleLikeBtn(btn, id, title, thumb, channel, duration) {
             const video = {id, title, thumbnail: thumb, channel, duration};
             const isLiked = LocalLikesManager.toggleLike(video);
             const icon = btn.querySelector('i');
             
             if (isLiked) {
                 icon.className = 'fas fa-heart text-red-500';
             } else {
                 icon.className = 'far fa-heart';
             }
             
             if (appState.searchContext === 'liked') {
                 loadLikedVideos(true);
             }
        }

        // פונקציה: ניגון אקראי מפלייליסט
        function playRandomFromPlaylist(playlistName) {
            const playlists = PlaylistManager.getPlaylists();
            const videos = playlists[playlistName] || [];
            
            if (videos.length === 0) return alert('הפלייליסט ריק');
            
            const randomVideo = videos[Math.floor(Math.random() * videos.length)];
            openPlayer(randomVideo.id, randomVideo.title, randomVideo.thumbnail, randomVideo.channel, randomVideo.duration);
        }

        function updateLikeButtonUI(isLiked) {
            const btn = document.getElementById('playerLikeBtn');
            const icon = btn.querySelector('i');
            if (isLiked) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.classList.add('text-red-500');
                btn.classList.add('text-white');
            } else {
                icon.classList.remove('fas');
                icon.classList.remove('text-red-500');
                icon.classList.add('far');
                btn.classList.remove('text-white');
            }
        }

        // --- פונקציה לטעינת דף "אהבתי" ---
        function loadLikedVideos(isHistoryNav = false) {
            setActiveNavItem('navLiked');
            appState.searchContext = 'liked';
            document.getElementById('channelFilterContainer').classList.add('hidden');
            
            if (!isHistoryNav) pushHistory({ type: 'liked' });

            const titleEl = document.getElementById('sectionTitle');
            titleEl.innerText = "סרטונים שאהבתי (מקומי)";
            titleEl.classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
            
            if (appState.currentVideoId) minimizePlayer();

            const likes = LocalLikesManager.getLikes();

            if (likes.length === 0) {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">עדיין לא סימנת סרטונים ב"אהבתי".<br>לחץ על כפתור הלב בנגן כדי להוסיף.</div>';
                appState.currentRenderedItems = [];
                return;
            }

            const formattedItems = likes.map(item => ({
                id: { kind: 'youtube#video', videoId: item.id },
                snippet: {
                    title: item.title,
                    channelTitle: item.channel,
                    thumbnails: { high: { url: item.thumbnail }, medium: { url: item.thumbnail } },
                    publishedAt: item.addedAt
                },
                contentDetails: { duration: item.duration },
                statistics: { viewCount: 0 }
            }));

            renderResults(formattedItems, true);
        }

        function loadPlaylistsToSidebar() {
            const playlists = PlaylistManager.getPlaylists();
            const container = document.getElementById('playlistsNavContainer'); 
            if(!container) return;
            
            container.innerHTML = '';
            Object.keys(playlists).forEach(name => {
                const div = document.createElement('div');
                div.className = 'sidebar-item';
                div.onclick = () => loadPlaylistView(name);
                const icon = name === 'Watch Later' ? 'fa-clock' : 'fa-list';
                const label = name === 'Watch Later' ? 'צפייה בהמשך' : name;
                
                div.innerHTML = `<i class="fas ${icon} text-lg"></i><span>${label}</span>`;
                container.appendChild(div);
            });
        }

        function loadPlaylistView(name, isInternal = false) {
            setActiveNavItem(''); 
            appState.searchContext = 'playlist_' + name;
            document.getElementById('channelFilterContainer').classList.add('hidden');
            
            if (!isInternal) pushHistory({ type: 'playlist', playlistName: name });

            const titleEl = document.getElementById('sectionTitle');
            const isWatchLater = name === 'Watch Later';
            const safeName = name.replace(/"/g, "&quot;");
            
            let titleHTML = isWatchLater ? 'צפייה בהמשך' : `רשימת השמעה: ${safeName}`;
            
            if (!isWatchLater) {
                titleHTML += `
                    <span class="mr-4 text-sm font-normal">
                        <button onclick="const newName = prompt('שם חדש:', '${safeName}'); if(newName) PlaylistManager.renamePlaylist('${safeName}', newName)" 
                            class="mx-1 text-blue-400 hover:text-blue-300" title="שנה שם">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="PlaylistManager.deletePlaylist('${safeName}')" 
                            class="mx-1 text-red-500 hover:text-red-400" title="מחק רשימה">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </span>
                `;
            }
            
            titleHTML += `
                <button onclick="playRandomFromPlaylist('${safeName}')" 
                    class="mr-4 bg-[#cc0000] text-white text-xs px-3 py-1.5 rounded-full font-bold hover:bg-red-700 transition inline-flex items-center gap-2">
                    <i class="fas fa-random"></i> נגן באקראי
                </button>
            `;

            titleEl.innerHTML = titleHTML;
            titleEl.classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
            
            if (appState.currentVideoId) minimizePlayer();

            const playlists = PlaylistManager.getPlaylists();
            const videos = playlists[name] || [];

            if (videos.length === 0) {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">הרשימה ריקה.</div>';
                appState.currentRenderedItems = [];
                return;
            }

            const formattedItems = videos.map(item => ({
                id: { kind: 'youtube#video', videoId: item.id },
                snippet: {
                    title: item.title,
                    channelTitle: item.channel,
                    thumbnails: { high: { url: item.thumbnail }, medium: { url: item.thumbnail } },
                    publishedAt: item.addedAt
                },
                contentDetails: { duration: item.duration }, 
                statistics: { viewCount: 0 } 
            }));

            renderResults(formattedItems, true);
        }

        function exportData() {
            const data = {
                history: localStorage.getItem('yt_local_history'),
                playlists: localStorage.getItem('yt_playlists'),
                likes: localStorage.getItem('yt_local_likes'),
                continue_watching: localStorage.getItem('yt_continue_watching'),
                settings: {
                    apiKey: localStorage.getItem('yt_api_key'),
                    clientId: localStorage.getItem('yt_client_id')
                }
            };
            
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `yt_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.history) localStorage.setItem('yt_local_history', data.history);
                    if(data.playlists) localStorage.setItem('yt_playlists', data.playlists);
                    if(data.likes) localStorage.setItem('yt_local_likes', data.likes); 
                    if(data.continue_watching) localStorage.setItem('yt_continue_watching', data.continue_watching);
                    if(data.settings) {
                        if(data.settings.apiKey) localStorage.setItem('yt_api_key', data.settings.apiKey);
                    }
                    alert('הנתונים שוחזרו בהצלחה! הדף יתרענן כעת.');
                    location.reload();
                } catch(err) {
                    alert('שגיאה בקריאת הקובץ');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function saveToLocalHistory(id, title, thumbnail, channelName) {
            if (!id) return;
            let history = JSON.parse(localStorage.getItem('yt_local_history') || '[]');
            history = history.filter(item => item.id !== id);
            history.unshift({
                id: id,
                title: title,
                thumbnail: thumbnail,
                channel: channelName,
                timestamp: new Date().toISOString()
            });
            if (history.length > 50) history.pop();
            localStorage.setItem('yt_local_history', JSON.stringify(history));
        }

        function loadLocalHistory(isHistoryNav = false) {
            setActiveNavItem('navLocalHistory');
            appState.searchContext = 'local_history'; 
            document.getElementById('channelFilterContainer').classList.add('hidden');
            
            if (!isHistoryNav) pushHistory({ type: 'local_history' });

            document.getElementById('sectionTitle').innerText = "היסטוריית צפייה מקומית (מהמחשב הזה)";
            document.getElementById('sectionTitle').classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
            
            if (appState.currentVideoId) minimizePlayer();

            const history = JSON.parse(localStorage.getItem('yt_local_history') || '[]');
            
            if (history.length === 0) {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">עדיין אין היסטוריה מקומית.<br>צפה בסרטונים כדי לראות אותם כאן.</div>';
                appState.currentRenderedItems = [];
                return;
            }

            const formattedItems = history.map(item => ({
                id: { kind: 'youtube#video', videoId: item.id },
                snippet: {
                    title: item.title,
                    channelTitle: item.channel,
                    thumbnails: { high: { url: item.thumbnail }, medium: { url: item.thumbnail } },
                    publishedAt: item.timestamp 
                },
                statistics: { viewCount: 0, likeCount: 0 }
            }));

            renderResults(formattedItems, true);

            const grid = document.getElementById('resultsGrid');
            const clearBtn = document.createElement('div');
            clearBtn.className = "col-span-full flex justify-center mt-8";
            clearBtn.innerHTML = `
                <button onclick="clearLocalHistory()" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-6 py-2 rounded-full text-sm border border-red-800 transition">
                    <i class="fas fa-trash-alt ml-2"></i> מחק הכל
                </button>
            `;
            grid.appendChild(clearBtn);
        }

        function clearLocalHistory() {
            if(confirm("האם למחוק את כל ההיסטוריה המקומית?")) {
                localStorage.removeItem('yt_local_history');
                loadLocalHistory();
            }
        }

        function removeFromLocalHistory(id, event) {
            if (event) event.stopPropagation();
            if(confirm("להסיר סרטון זה מההיסטוריה?")) {
                let history = JSON.parse(localStorage.getItem('yt_local_history') || '[]');
                history = history.filter(item => item.id !== id);
                localStorage.setItem('yt_local_history', JSON.stringify(history));
                loadLocalHistory(true); 
            }
        }

        async function toggleExternalPip() {
            const playerContainer = document.querySelector('.player-container');
            const watchView = document.getElementById('watchView');

            if (!('documentPictureInPicture' in window)) {
                alert("הדפדפן שלך לא תומך במצב PiP חיצוני מלא (Document PiP).");
                return;
            }

            try {
                if (window.documentPictureInPicture.window) {
                    window.documentPictureInPicture.window.close();
                    return;
                }

                const pipWindow = await window.documentPictureInPicture.requestWindow({
                    width: playerContainer.clientWidth,
                    height: playerContainer.clientHeight,
                });

                [...document.styleSheets].forEach((styleSheet) => {
                    try {
                        const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                        const style = document.createElement('style');
                        style.textContent = cssRules;
                        pipWindow.document.head.appendChild(style);
                    } catch (e) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.type = styleSheet.type;
                        link.media = styleSheet.media;
                        link.href = styleSheet.href;
                        pipWindow.document.head.appendChild(link);
                    }
                });

                pipWindow.document.body.append(playerContainer);
                playerContainer.classList.add('h-screen', 'w-screen');
                
                pipWindow.addEventListener("pagehide", (event) => {
                     const watchViewInner = document.getElementById('watchView');
                     watchViewInner.append(playerContainer);
                     playerContainer.classList.remove('h-screen', 'w-screen');
                });

            } catch (err) {
                console.error("PiP Error:", err);
            }
        }

        const returnToVideoBtn = document.getElementById('return-to-video-btn');
        const globalPauseBtn = document.getElementById('global-pause-btn');
        const watchView = document.getElementById('watchView');
        const playerFrame = document.getElementById('playerFrame');

        globalPauseBtn.addEventListener('click', () => {
            if (ytPlayer && typeof ytPlayer.getPlayerState === 'function') {
                const state = ytPlayer.getPlayerState();
                if (state === 1) { // Playing
                    ytPlayer.pauseVideo();
                } else {
                    ytPlayer.playVideo();
                }
            } else {
                // Fallback if API not ready
                if (appState.isVideoPaused) {
                    playerFrame.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                    globalPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    appState.isVideoPaused = false;
                } else {
                    playerFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                    globalPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
                    appState.isVideoPaused = true;
                }
            }
        });

        returnToVideoBtn.addEventListener('click', () => {
            if (appState.isFloating) {
                watchView.classList.remove('hidden');
            } else {
                watchView.classList.add('active'); 
                watchView.classList.remove('hidden');
            }
            returnToVideoBtn.classList.add('hidden'); 
        });

        function toggleFloatingMode() {
            const view = document.getElementById('watchView');
            appState.isFloating = !appState.isFloating;
            
            if (appState.isFloating) {
                view.classList.add('floating-mode');
                document.body.style.overflow = 'auto'; 
            } else {
                view.classList.remove('floating-mode');
                document.body.style.overflow = 'hidden'; 
            }
        }

        function minimizePlayer() {
            saveCurrentProgress(); // Save before hiding
            if (appState.isFloating) {
                const view = document.getElementById('watchView');
                view.classList.add('hidden'); 
                returnToVideoBtn.classList.remove('hidden');
                document.body.style.overflow = 'auto'; 
            } else if (appState.currentVideoId) {
                watchView.classList.remove('active');
                watchView.classList.add('hidden');
                returnToVideoBtn.classList.remove('hidden');
                document.body.style.overflow = 'auto'; 
            } else {
                closePlayer();
            }
        }

        function toggleConfig() {
            const modal = document.getElementById('configModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function saveAndStart() {
            const newKey = document.getElementById('apiKeyInput').value.trim();
            const newClientId = document.getElementById('clientIdInput').value.trim();
            const newMaxResults = document.getElementById('maxResultsInput').value.trim(); // NEW

            if (!newKey) return alert("נא להזין API Key לפחות.");
            
            appState.apiKey = newKey;
            appState.clientId = newClientId;
            // Validate Max Results
            appState.maxResults = newMaxResults ? parseInt(newMaxResults) : 12;
            if (appState.maxResults < 1) appState.maxResults = 1;
            if (appState.maxResults > 50) appState.maxResults = 50;
            
            localStorage.setItem('yt_api_key', appState.apiKey);
            localStorage.setItem('yt_client_id', appState.clientId);
            localStorage.setItem('yt_max_results', appState.maxResults); // NEW
            
            document.getElementById('configModal').style.display = 'none';
            
            if (appState.clientId) initAuth();
            initChart();
            loadHomePage();
        }

        function handleLogout() {
            if (appState.token) {
                google.accounts.oauth2.revoke(appState.token, () => {
                    console.log('Token revoked.');
                });
            }
            appState.token = null;
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('userDisplay').classList.add('hidden');
            document.getElementById('userName').innerText = '';
            document.getElementById('userImg').src = '';
            loadHomePage(); 
        }

        window.onload = () => {
            const savedKey = localStorage.getItem('yt_api_key');
            const savedClient = localStorage.getItem('yt_client_id');
            const savedMaxResults = localStorage.getItem('yt_max_results'); // NEW

            if(savedKey) document.getElementById('apiKeyInput').value = savedKey;
            if(savedClient) document.getElementById('clientIdInput').value = savedClient;
            if(savedMaxResults) document.getElementById('maxResultsInput').value = savedMaxResults; // NEW
            
            loadPlaylistsToSidebar();

            if(savedKey) {
                appState.apiKey = savedKey;
                appState.clientId = savedClient;
                appState.maxResults = savedMaxResults ? parseInt(savedMaxResults) : 12; // NEW
                saveAndStart();
            } else {
                toggleConfig();
            }
        };

        function initAuth() {
            try {
                appState.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: appState.clientId,
                    scope: 'https://www.googleapis.com/auth/youtube.readonly',
                    callback: (tokenResponse) => {
                        if (tokenResponse.error !== undefined) throw (tokenResponse);
                        appState.token = tokenResponse.access_token;
                        updateUserInfo();
                        loadHomePage();
                    },
                });
            } catch (e) { console.error("Auth init error", e); }
        }

        function requestToken() {
            if (appState.tokenClient) {
                appState.tokenClient.requestAccessToken();
            } else {
                alert("אנא הגדר Client ID תקין בהגדרות כדי להתחבר.");
                toggleConfig();
            }
        }

        async function updateUserInfo() {
            try {
                const res = await fetch(`https://www.googleapis.com/oauth2/v3/userinfo`, {
                    headers: { Authorization: `Bearer ${appState.token}` }
                });
                const data = await res.json();
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('userDisplay').classList.remove('hidden');
                document.getElementById('userImg').src = data.picture;
                document.getElementById('userName').innerText = data.name;
            } catch(e) { console.error("UserInfo fetch error", e); }
        }

        function initChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            if(appState.chart) appState.chart.destroy();
            appState.chart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: '#ff0000', borderRadius: 4 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, 
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#555', font: { size: 8 } } } } 
                }
            });
        }

        async function loadHomePage(isHistoryNav = false) {
            setActiveNavItem('navHome');
            appState.searchContext = 'general';
            document.getElementById('channelFilterContainer').classList.add('hidden');
            document.getElementById('searchInput').value = "";
            appState.pageToken = "";

            if (!isHistoryNav) pushHistory({ type: 'home' });
            
            if (appState.currentVideoId) {
                minimizePlayer();
            } else {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">טוען...</div>';
            }

            document.getElementById('pagination').classList.add('hidden');
            
            const titleEl = document.getElementById('sectionTitle');
            titleEl.classList.remove('hidden');
            titleEl.innerText = appState.token ? "מומלצים עבורך" : "סרטונים פופולריים בישראל";
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 

            try {
                // Use maxResults
                let url = appState.token 
                    ? `https://www.googleapis.com/youtube/v3/activities?part=snippet,contentDetails&mine=true&maxResults=${appState.maxResults}&key=${appState.apiKey}`
                    : `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&chart=mostPopular&regionCode=IL&maxResults=${appState.maxResults}&key=${appState.apiKey}`;

                const headers = appState.token ? { Authorization: `Bearer ${appState.token}` } : {};
                const res = await fetch(url, { headers });
                const data = await res.json();
                
                let videoIds = [];
                if (appState.token && data.items) {
                    videoIds = data.items
                        .filter(i => i.contentDetails.upload || i.contentDetails.playlistItem)
                        .map(i => i.contentDetails.upload?.videoId || i.contentDetails.playlistItem?.resourceId?.videoId)
                        .filter(Boolean);
                } else if (data.items) {
                    videoIds = data.items.map(i => i.id);
                }

                if (videoIds.length > 0) {
                    fetchAndRenderVideos(videoIds, true);
                } else {
                    document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">לא נמצאו סרטונים להצגה.</div>';
                    appState.currentRenderedItems = [];
                }
            } catch (err) { console.error(err); }
        }

        async function loadWatchHistory(isHistoryNav = false) {
            if (!appState.token) return alert("יש להתחבר לחשבון גוגל.");
            setActiveNavItem('navHistory');
            appState.searchContext = 'general';
            document.getElementById('channelFilterContainer').classList.add('hidden');
            
            if (!isHistoryNav) pushHistory({ type: 'history' });

            if (appState.currentVideoId) {
                minimizePlayer();
            } else {
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">טוען פעילות...</div>';
            }
            
            document.getElementById('pagination').classList.add('hidden');
            const titleEl = document.getElementById('sectionTitle');
            titleEl.classList.remove('hidden');
            titleEl.innerText = "פעילות אחרונה בחשבון";
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 

            try {
                // maxResults logic could apply here too, but staying close to original intent of "history"
                const url = `https://www.googleapis.com/youtube/v3/activities?part=snippet,contentDetails&mine=true&maxResults=20&key=${appState.apiKey}`;
                const res = await fetch(url, { headers: { Authorization: `Bearer ${appState.token}` } });
                const data = await res.json();

                const videoIds = (data.items || [])
                    .map(i => i.contentDetails.upload?.videoId || i.contentDetails.playlistItem?.resourceId?.videoId || i.contentDetails.like?.resourceId?.videoId)
                    .filter(Boolean);

                if(videoIds.length > 0) fetchAndRenderVideos(videoIds, true);
                else {
                    document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">לא נמצאה פעילות אחרונה.</div>';
                    appState.currentRenderedItems = [];
                }
            } catch(e) { console.error(e); }
        }

        async function performSearch(loadMore, isHistoryNav = false) {
            const query = document.getElementById('searchInput').value.trim();

            // --- FIX: Redirect for Channel/Playlist Load More ---
            if (loadMore) {
                if (appState.searchContext === 'channel') {
                    return loadChannelVideos(appState.activeChannelId, true);
                }
                if (appState.searchContext === 'channel_playlists') {
                    return loadChannelPlaylists(appState.activeChannelId, true);
                }
            }
            // ---------------------------------------------------

            const order = document.getElementById('searchOrder').value;
            let type = document.getElementById('searchType').value || 'video,channel,playlist'; 
            const duration = document.getElementById('searchDuration').value;

            if (!query) return loadHomePage();

            if (duration) {
                type = 'video';
                document.getElementById('searchType').value = 'video';
            }

            if (!loadMore) {
                appState.searchContext = 'general';
                document.getElementById('channelFilterContainer').classList.add('hidden');
                setActiveNavItem('');
                document.getElementById('sectionTitle').classList.remove('hidden');
                document.getElementById('sectionTitle').innerText = `תוצאות חיפוש: ${query}`;
                document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
                
                appState.query = query;
                appState.pageToken = "";
                
                if (!isHistoryNav) {
                    pushHistory({
                        type: 'search',
                        query: query,
                        filterType: type,
                        order: order,
                        duration: duration
                    });
                }

                if (appState.currentVideoId) {
                    minimizePlayer();
                    document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">מחפש...</div>';
                } else {
                    document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">מחפש...</div>';
                }
            }

            try {
                // Use maxResults
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=${appState.maxResults}&q=${encodeURIComponent(appState.query)}&order=${order}&type=${type}&key=${appState.apiKey}`;
                if (duration) url += `&videoDuration=${duration}`;
                if (appState.pageToken) url += `&pageToken=${appState.pageToken}`;

                const response = await fetch(url);
                const data = await response.json();
                
                appState.pageToken = data.nextPageToken || "";
                document.getElementById('pagination').classList.toggle('hidden', !appState.pageToken);

                const items = data.items || [];
                const videoIds = items.filter(i => i.id.kind === 'youtube#video').map(i => i.id.videoId);
                const otherItems = items.filter(i => i.id.kind !== 'youtube#video'); 
                
                if (videoIds.length > 0) {
                     const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds.join(',')}&key=${appState.apiKey}`);
                     const statsData = await statsRes.json();
                     const combinedItems = [...otherItems, ...statsData.items.map(i => ({
                         id: { kind: 'youtube#video', videoId: i.id },
                         snippet: i.snippet,
                         statistics: i.statistics,
                         contentDetails: i.contentDetails
                     }))];
                     renderResults(combinedItems, !loadMore);
                     updateChart(statsData.items || []);
                } else {
                    renderResults(otherItems, !loadMore);
                }
            } catch (err) { console.error(err); }
        }

        async function fetchAndRenderVideos(ids, clear) {
            if (!ids.length) return;
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${ids.join(',')}&key=${appState.apiKey}`);
                const data = await res.json();
                const formatted = data.items.map(item => ({
                    id: { kind: 'youtube#video', videoId: item.id },
                    snippet: item.snippet,
                    statistics: item.statistics,
                    contentDetails: item.contentDetails
                }));
                renderResults(formatted, clear);
                updateChart(data.items || []);
            } catch (e) { console.error(e); }
        }

        async function loadChannelVideos(channelId, loadMore = false, isHistoryNav = false) {
            // Fix: ensure ID if loading more
            if (loadMore && !channelId) channelId = appState.activeChannelId;

            if (!loadMore) {
                if (appState.currentVideoId) minimizePlayer();

                if (!isHistoryNav && channelId) {
                    pushHistory({ type: 'channel', channelId: channelId });
                }

                try {
                    document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">טוען ערוץ...</div>';
                    document.getElementById('sectionTitle').innerText = "טוען...";
                    document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
                    
                    const res = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails,snippet&id=${channelId}&key=${appState.apiKey}`);
                    const data = await res.json();
                    
                    if (!data.items || !data.items.length) {
                        return;
                    }
                    
                    const channel = data.items[0];
                    const uploadsPlaylistId = channel.contentDetails.relatedPlaylists.uploads;
                    
                    appState.query = uploadsPlaylistId; 
                    appState.searchContext = 'channel';
                    appState.activeChannelId = channelId; 
                    appState.pageToken = "";
                    
                    document.getElementById('sectionTitle').innerText = `סרטונים מאת: ${channel.snippet.title}`;

                    const filterContainer = document.getElementById('channelFilterContainer');
                    filterContainer.innerHTML = `
                        <button onclick="loadChannelVideos('${channelId}')" class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-bold">סרטונים</button>
                        <button onclick="loadChannelPlaylists('${channelId}')" class="bg-[#222] hover:bg-[#333] text-white px-4 py-1.5 rounded-full text-sm font-bold border border-[#333] transition">פלייליסטים</button>
                    `;
                    filterContainer.classList.remove('hidden');

                } catch(e) { console.error(e); return; }
            }

            try {
                // Use maxResults
                let url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=${appState.maxResults}&playlistId=${appState.query}&key=${appState.apiKey}`;
                if (appState.pageToken) url += `&pageToken=${appState.pageToken}`;

                const res = await fetch(url);
                const data = await res.json();

                appState.pageToken = data.nextPageToken || "";
                document.getElementById('pagination').classList.toggle('hidden', !appState.pageToken);

                const videoIds = data.items.map(item => item.snippet.resourceId.videoId).join(',');
                if(videoIds) {
                    const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds}&key=${appState.apiKey}`);
                    const statsData = await statsRes.json();
                     const formatted = statsData.items.map(item => ({
                        id: { kind: 'youtube#video', videoId: item.id },
                        snippet: item.snippet,
                        statistics: item.statistics,
                        contentDetails: item.contentDetails
                    }));
                    renderResults(formatted, !loadMore);
                    updateChart(statsData.items);
                }

            } catch(e) { console.error(e); }
        }

        async function loadChannelPlaylists(channelId, loadMore = false) {
             // Fix: ensure ID if loading more
             if (loadMore && !channelId) channelId = appState.activeChannelId;

             if (!loadMore) {
                appState.searchContext = 'channel_playlists';
                appState.activeChannelId = channelId;
                appState.pageToken = "";
                
                const filterContainer = document.getElementById('channelFilterContainer');
                filterContainer.innerHTML = `
                    <button onclick="loadChannelVideos('${channelId}')" class="bg-[#222] hover:bg-[#333] text-white px-4 py-1.5 rounded-full text-sm font-bold border border-[#333] transition">סרטונים</button>
                    <button onclick="loadChannelPlaylists('${channelId}')" class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-bold">פלייליסטים</button>
                `;
                
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">טוען פלייליסטים...</div>';
            }

            try {
                // Use maxResults
                let url = `https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails&channelId=${channelId}&maxResults=${appState.maxResults}&key=${appState.apiKey}`;
                if (appState.pageToken) url += `&pageToken=${appState.pageToken}`;

                const res = await fetch(url);
                const data = await res.json();

                appState.pageToken = data.nextPageToken || "";
                document.getElementById('pagination').classList.toggle('hidden', !appState.pageToken);

                if (!data.items || data.items.length === 0) {
                    if (!loadMore) document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">לא נמצאו פלייליסטים לערוץ זה.</div>';
                    return;
                }

                const formatted = data.items.map(item => ({
                    id: { kind: 'youtube#playlist', playlistId: item.id }, 
                    snippet: item.snippet,
                    contentDetails: item.contentDetails
                }));

                renderResults(formatted, !loadMore);

            } catch (e) { 
                console.error(e); 
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 text-red-400">שגיאה בטעינת פלייליסטים.</div>';
            }
        }

        async function openExternalPlaylist(playlistId, title) {
            appState.query = playlistId;
            appState.searchContext = 'channel'; 
            appState.pageToken = "";
            appState.activeChannelId = null; 
            
            document.getElementById('channelFilterContainer').classList.add('hidden');
            document.getElementById('sectionTitle').innerText = `פלייליסט: ${title}`;
            document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">טוען סרטונים...</div>';
            document.getElementById('exportUrlsBtn').classList.remove('hidden'); 
            
            loadChannelVideos(null, true); 
        }

        function renderResults(items, clear) {
            const grid = document.getElementById('resultsGrid');
            if (clear) {
                grid.innerHTML = '';
                appState.currentRenderedItems = []; 
            }
            
            appState.currentRenderedItems = [...appState.currentRenderedItems, ...items];
            
            items.forEach(item => {
                const snip = item.snippet;
                const kind = item.id.kind;
                
                // --- עיבוד ערוץ ---
                if (kind === 'youtube#channel') {
                    const channelId = item.id.channelId;
                    const card = document.createElement('div');
                    card.className = "video-card group flex flex-col items-center p-4 bg-[#1a1a1a] rounded-2xl cursor-pointer hover:bg-[#252525] transition border border-[#222]";
                    card.onclick = () => loadChannelVideos(channelId);
                    card.innerHTML = `
                        <div class="mb-4">
                            <img src="${snip.thumbnails?.high?.url || snip.thumbnails?.medium?.url || snip.thumbnails?.default?.url}" class="w-32 h-32 rounded-full object-cover border-2 border-[#333]">
                        </div>
                        <h3 class="font-bold text-lg text-center mb-1">${snip.title}</h3>
                        <p class="text-gray-500 text-xs text-center mb-3">ערוץ</p>
                        <button class="bg-[#cc0000] text-white text-xs font-bold px-4 py-2 rounded-full hover:bg-red-700 transition">
                            צפה בערוץ
                        </button>
                    `;
                    grid.appendChild(card);
                    return;
                }

                // --- עיבוד פלייליסט ---
                if (kind === 'youtube#playlist') {
                    const playlistId = item.id.playlistId;
                    const card = document.createElement('div');
                    card.className = "video-card group flex flex-col cursor-pointer";
                    const title = snip.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const thumbUrl = snip.thumbnails?.medium?.url || snip.thumbnails?.high?.url || snip.thumbnails?.default?.url || '';
                    const channelTitle = snip.channelTitle || '';
                    
                    card.innerHTML = `
                         <div class="relative mb-4 group/img" onclick="openExternalPlaylist('${playlistId}', '${title}')">
                            <div class="relative">
                                <img src="${thumbUrl}" class="w-full aspect-video object-cover rounded-2xl bg-[#222]">
                                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition rounded-2xl">
                                    <span class="text-white font-bold">נגן הכל</span>
                                </div>
                                <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                                    <i class="fas fa-list-ul"></i>
                                    <span>${item.contentDetails?.itemCount || ''} סרטונים</span>
                                </div>
                            </div>
                        </div>
                        <div class="px-1">
                            <h3 class="text-white font-semibold text-base leading-snug line-clamp-2 mb-1" title="${snip.title}">${snip.title}</h3>
                            <p class="text-[#aaaaaa] text-sm hover:text-white transition-colors" onclick="event.stopPropagation(); loadChannelVideos('${snip.channelId}')">
                                ${channelTitle}
                            </p>
                            <button onclick="event.stopPropagation(); openExternalPlaylist('${playlistId}', '${title}')" class="mt-2 bg-[#cc0000] text-white text-xs px-3 py-1.5 rounded-full font-bold hover:bg-red-700 transition flex items-center gap-2 w-fit">
                                <i class="fas fa-play"></i> נגן הכל
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                    return;
                }

                // --- עיבוד סרטון ---
                const videoId = item.id.videoId;
                if (!videoId) return;

                let viewsText = '';
                let likesText = '';
                let timeText = '';
                let durationText = '';
                let progressHTML = '';

                const title = snip.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const channelTitle = snip.channelTitle || '';
                const thumbUrl = snip.thumbnails?.high?.url || snip.thumbnails?.medium?.url || snip.thumbnails?.default?.url || '';
                const safeChannel = channelTitle.replace(/'/g, "\\'").replace(/"/g, "&quot;");

                if (item.statistics) {
                    const views = item.statistics.viewCount;
                    const likes = item.statistics.likeCount;
                    const date = snip.publishedAt;
                    
                    if(views) viewsText = `${formatCount(views)} צפיות`;
                    if(likes) likesText = ` • ${formatCount(likes)} לייקים`;
                    if(date) timeText = ` • ${timeSince(date)}`;
                }

                if (item.contentDetails && item.contentDetails.duration) {
                    durationText = `<span class="absolute bottom-2 left-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded font-bold">${parseDuration(item.contentDetails.duration)}</span>`;
                    
                    // Show progress bar if we have timestamp and duration
                    if (item.timestamp && item.timestamp > 0) {
                        const totalSeconds = parseDurationToSeconds(item.contentDetails.duration);
                        if (totalSeconds > 0) {
                            const percent = Math.min((item.timestamp / totalSeconds) * 100, 100);
                            progressHTML = `
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${percent}%"></div>
                                </div>
                            `;
                        }
                    }
                }

                const card = document.createElement('div');
                card.className = "video-card group flex flex-col cursor-pointer";
                
                const durationForSave = item.contentDetails?.duration || '';
                
                const isLiked = LocalLikesManager.isLiked(videoId);
                const likeIconClass = isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart';
                const isSaved = LocalContinueWatchingManager.isInList(videoId);
                const savedIconClass = isSaved ? 'fas fa-check text-blue-300' : 'fas fa-plus';
                
                card.innerHTML = `
                    <div class="relative mb-4 group/img" onclick="openPlayer('${videoId}', '${title}', '${thumbUrl}', '${safeChannel}', '${durationForSave}', ${appState.currentRenderedItems.indexOf(item)})">
                        <img src="${thumbUrl}" class="w-full aspect-video object-cover rounded-2xl bg-[#222]">
                        ${durationText}
                        ${progressHTML}
                        
                        <button onclick="event.stopPropagation(); PlaylistManager.addToPlaylist('Watch Later', {id: '${videoId}', title: '${title}', thumbnail: '${thumbUrl}', channel: '${safeChannel}', duration: '${durationForSave}'})" 
                            class="absolute top-2 left-2 bg-black/60 hover:bg-blue-600 text-white p-1.5 rounded-lg opacity-0 group-hover/img:opacity-100 transition backdrop-blur-sm shadow-lg" title="צפייה בהמשך">
                            <i class="fas fa-clock"></i>
                        </button>
                    </div>
                    <div class="flex gap-3 px-1">
                        <div class="w-9 h-9 rounded-full bg-gray-800 flex-shrink-0 border border-[#333] flex items-center justify-center">
                            <i class="fas fa-play text-[10px] opacity-30"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-semibold text-base leading-snug line-clamp-2" title="${snip.title}" onclick="openPlayer('${videoId}', '${title}', '${thumbUrl}', '${safeChannel}', '${durationForSave}', ${appState.currentRenderedItems.indexOf(item)})">${snip.title}</h3>
                            <div class="text-[#aaaaaa] text-sm mt-1">
                                <p class="hover:text-white transition-colors" onclick="loadChannelVideos('${snip.channelId}')">${channelTitle}</p>
                                <p>${viewsText}${likesText}${timeText}</p> 
                            </div>
                            <div class="flex items-center gap-2 mt-3 flex-wrap">
                                <button onclick="event.stopPropagation(); copyLink('${videoId}')" class="flex items-center gap-2 text-[10px] bg-[#272727] hover:bg-[#444] px-3 py-1.5 rounded-full transition w-fit border border-[#333]">
                                    <i class="fas fa-link"></i>
                                </button>
                                
                                <button onclick="event.stopPropagation(); toggleLikeBtn(this, '${videoId}', '${title.replace(/'/g, "\\'")}', '${thumbUrl}', '${safeChannel}', '${durationForSave}')" 
                                    class="flex items-center gap-2 text-[10px] bg-[#272727] hover:bg-[#444] px-3 py-1.5 rounded-full transition w-fit border border-[#333]" title="אהבתי">
                                    <i class="${likeIconClass}"></i>
                                </button>
                                
                                <button onclick="event.stopPropagation(); const name = prompt('הכנס שם רשימה (למשל: מוזיקה, הרצאות):'); if(name) PlaylistManager.addToPlaylist(name, {id: '${videoId}', title: '${title}', thumbnail: '${thumbUrl}', channel: '${safeChannel}', duration: '${durationForSave}'})" 
                                    class="flex items-center gap-2 text-[10px] bg-[#272727] hover:bg-[#444] px-3 py-1.5 rounded-full transition w-fit border border-[#333]" title="שמור לרשימה">
                                    <i class="fas fa-list-ul"></i> שמירה
                                </button>

                                ${appState.searchContext === 'local_history' ? `
                                <button onclick="removeFromLocalHistory('${videoId}', event)" class="flex items-center justify-center text-[10px] bg-[#330000] text-red-400 hover:bg-red-900 px-3 py-1.5 rounded-full transition w-fit border border-red-900/50" title="הסר מההיסטוריה">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                ` : ''}

                                ${appState.searchContext.startsWith('playlist_') ? `
                                <button onclick="event.stopPropagation(); PlaylistManager.removeFromPlaylist('${appState.searchContext.replace('playlist_', '')}', '${videoId}')" 
                                    class="text-[10px] bg-red-900/50 hover:bg-red-800 text-red-300 px-3 py-1.5 rounded-full border border-red-900/50 transition" title="הסר מרשימה">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}

                                ${appState.searchContext === 'continue_watching' ? `
                                <button onclick="event.stopPropagation(); LocalContinueWatchingManager.toggle({id: '${videoId}'}); loadContinueWatching(true);" 
                                    class="text-[10px] bg-blue-900/50 hover:bg-blue-800 text-blue-300 px-3 py-1.5 rounded-full border border-blue-900/50 transition" title="הסר מהמשך צפייה">
                                    <i class="fas fa-check"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function updateChart(items) {
            if (!appState.chart || !items.length) return;
            const videoItems = items.filter(v => v.statistics);
            appState.chart.data.labels = videoItems.slice(0, 5).map(v => v.snippet.title.substring(0, 8) + '..');
            appState.chart.data.datasets[0].data = videoItems.slice(0, 5).map(v => parseInt(v.statistics?.likeCount || 0));
            appState.chart.update();
        }

        function setActiveNavItem(id) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            if(id) document.getElementById(id).classList.add('active');
        }

        async function openPlayer(id, title, thumbnail = '', channel = '', duration = '', index = -1) {
            saveToLocalHistory(id, title, thumbnail, channel);

            const view = document.getElementById('watchView');
            if(appState.isFloating) {
                toggleFloatingMode();
            }
            
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('fullTitle').innerText = title;
            
            appState.currentVideoDetails = { id, title, thumbnail, channel, duration };
            
            // --- NEW: Save Index for Autoplay ---
            if (index !== -1) {
                appState.currentVideoIndex = index;
            } else {
                // Try to find if not provided
                appState.currentVideoIndex = appState.currentRenderedItems.findIndex(item => {
                    const iId = item.id?.videoId || (typeof item.id === 'string' ? item.id : null);
                    return String(iId) === String(id);
                });
            }
            // ------------------------------------

            // Update UI buttons
            updateLikeButtonUI(LocalLikesManager.isLiked(id));
            updateContinueButtonUI(LocalContinueWatchingManager.isInList(id));

            // Determine start time from URL
            const startTime = LocalContinueWatchingManager.getTimeFromUrl(id);

            // Use API if ready
            if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
                ytPlayer.loadVideoById({videoId: id, startSeconds: startTime});
            } else {
                // If seeking is needed on iframe init, we append start param
                const startParam = startTime > 0 ? `&start=${Math.floor(startTime)}` : '';
                document.getElementById('playerFrame').src = `https://www.youtube.com/embed/${id}?autoplay=1&enablejsapi=1${startParam}`;
            }
            
            appState.currentVideoId = id;
            appState.isVideoPaused = false;
            
            document.getElementById('global-pause-btn').classList.remove('hidden');
            document.getElementById('global-pause-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
            document.getElementById('return-to-video-btn').classList.add('hidden');
            
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${id}&key=${appState.apiKey}`);
                const data = await res.json();
                const item = data.items[0];
                if (item) {
                    document.getElementById('modalDesc').innerHTML = linkify(item.snippet.description);
                    document.getElementById('modalStats').innerText = `${parseInt(item.statistics.viewCount).toLocaleString()} צפיות • ${new Date(item.snippet.publishedAt).toLocaleDateString('he-IL')}`;
                }
            } catch(e) {}
            
            view.classList.add('active'); 
            view.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePlayer() {
            stopProgressTracking();
            saveCurrentProgress();

            if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                ytPlayer.stopVideo();
            }
            
            document.getElementById('watchView').classList.remove('active');
            document.getElementById('watchView').classList.add('hidden');
            document.getElementById('watchView').classList.remove('floating-mode'); 
            appState.isFloating = false;
            
            // Only clear src if API didn't handle it
            if (!ytPlayer) document.getElementById('playerFrame').src = '';
            
            document.body.style.overflow = 'auto'; 
            
            appState.currentVideoId = null;
            appState.currentVideoIndex = -1; // Reset index
            appState.isVideoPaused = false;
            document.getElementById('global-pause-btn').classList.add('hidden');
            document.getElementById('return-to-video-btn').classList.add('hidden');
            
            // Refresh grid if we are in Continue Watching view to update progress bars
            if (appState.searchContext === 'continue_watching') {
                loadContinueWatching(true);
            }
        }

        function copyLink(id) {
            const url = `https://www.youtube.com/watch?v=${id}`;
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = url;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            
            const toast = document.getElementById('toast');
            toast.className = "copy-toast show";
            setTimeout(() => { toast.className = "copy-toast"; }, 3000);
        }

        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(false); });
    </script>
</body>
</html>
