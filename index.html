<script>
        let appState = {
            apiKey: localStorage.getItem('yt_api_key') || "",
            clientId: localStorage.getItem('yt_client_id') || "",
            pageToken: "",
            query: "",
            chart: null,
            token: null
        };

        window.onload = () => {
            if(appState.apiKey) {
                document.getElementById('apiKeyInput').value = appState.apiKey;
                document.getElementById('clientIdInput').value = appState.clientId;
                saveAndStart();
            } else {
                toggleConfig();
            }
        };

        function toggleConfig() { 
            const m = document.getElementById('configModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }

        function saveAndStart() {
            appState.apiKey = document.getElementById('apiKeyInput').value.trim();
            appState.clientId = document.getElementById('clientIdInput').value.trim();
            
            if (!appState.apiKey) return alert("חובה להזין מפתח API");

            localStorage.setItem('yt_api_key', appState.apiKey);
            localStorage.setItem('yt_client_id', appState.clientId);
            
            document.getElementById('configModal').style.display = 'none';
            try { initChart(); } catch(e) {}
            loadHomePage();
        }

        // --- התיקון המרכזי נמצא בפונקציה הזו ---
        async function performSearch(loadMore) {
            const query = document.getElementById('searchInput').value.trim();
            const order = document.getElementById('filterOrder').value;
            const duration = document.getElementById('filterDuration').value;
            const date = document.getElementById('filterDate').value;

            if (!query) return loadHomePage();

            setActiveNavItem('');
            document.getElementById('sectionTitle').classList.add('hidden');

            if (!loadMore) {
                appState.query = query;
                appState.pageToken = "";
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">מחפש...</div>';
            }

            try {
                // תיקון: אם יש מסננים פעילים, מחפשים רק וידאו כדי למנוע קריסה
                let type = 'video,channel';
                if (duration !== 'any' || date !== 'any') {
                    type = 'video';
                }

                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(appState.query)}&type=${type}&order=${order}&key=${appState.apiKey}`;
                
                if (appState.pageToken) url += `&pageToken=${appState.pageToken}`;
                if (duration !== 'any') url += `&videoDuration=${duration}`;
                
                if (date !== 'any') {
                    const now = new Date();
                    if (date === 'today') now.setDate(now.getDate() - 1);
                    if (date === 'week') now.setDate(now.getDate() - 7);
                    if (date === 'month') now.setMonth(now.getMonth() - 1);
                    url += `&publishedAfter=${now.toISOString()}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.error(data.error);
                    throw new Error("שגיאת API");
                }

                appState.pageToken = data.nextPageToken || "";
                document.getElementById('pagination').classList.toggle('hidden', !appState.pageToken);

                const items = data.items || [];
                
                // משיכת נתונים נוספים (צפיות ולייקים) רק עבור הסרטונים שנמצאו
                const videoIds = items.filter(i => i.id.kind === 'youtube#video').map(i => i.id.videoId);
                let statsMap = {};

                if (videoIds.length > 0) {
                    try {
                        const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoIds.join(',')}&key=${appState.apiKey}`);
                        const statsData = await statsRes.json();
                        if (statsData.items) {
                            statsData.items.forEach(item => {
                                statsMap[item.id] = item.statistics;
                            });
                            updateChart(statsData.items);
                        }
                    } catch (e) { console.log("שגיאה במשיכת סטטיסטיקות", e); }
                }

                // מיזוג הנתונים
                const finalItems = items.map(item => {
                    if (item.id.kind === 'youtube#video') {
                        return { ...item, statistics: statsMap[item.id.videoId] };
                    }
                    return item;
                });

                if (finalItems.length === 0) {
                     document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">לא נמצאו תוצאות. נסה לשנות את המסננים.</div>';
                } else {
                    renderResults(finalItems, !loadMore);
                }

            } catch (err) { 
                console.error(err);
                document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 text-red-500">שגיאה בחיפוש. וודא שמפתח ה-API תקין.</div>';
            }
        }

        function renderResults(items, clear) {
            const grid = document.getElementById('resultsGrid');
            if (clear) grid.innerHTML = '';

            items.forEach(item => {
                const snip = item.snippet;
                const isChannel = item.id.kind === 'youtube#channel';
                const id = isChannel ? item.id.channelId : (item.id.videoId || item.id);
                // הגנה מפני קריסה אם אין סטטיסטיקות
                const stats = item.statistics || {viewCount: '0', likeCount: '0'}; 
                
                const card = document.createElement('div');
                card.className = "video-card group flex flex-col cursor-pointer";
                
                if (isChannel) {
                    card.innerHTML = `
                        <div class="flex flex-col items-center py-6 bg-[#1a1a1a] rounded-2xl border border-[#333] hover:border-red-600 transition h-full" onclick="window.open('https://www.youtube.com/channel/${id}', '_blank')">
                            <img src="${snip.thumbnails.high.url}" class="w-24 h-24 rounded-full mb-4 border-2 border-[#333] object-cover">
                            <h3 class="font-bold text-md text-white text-center px-4 line-clamp-1">${snip.title}</h3>
                            <span class="bg-[#272727] text-gray-400 text-[10px] px-3 py-1 rounded-full mt-3 font-bold">ערוץ</span>
                        </div>`;
                } else {
                    card.innerHTML = `
                        <div class="relative mb-4" onclick="openPlayer('${id}', '${snip.title.replace(/'/g, "\\'")}')">
                            <img src="${snip.thumbnails.high.url}" class="w-full aspect-video object-cover rounded-2xl bg-[#222]">
                        </div>
                        <div class="flex gap-3 px-1 text-right" dir="rtl">
                            <div class="w-9 h-9 rounded-full bg-gray-800 flex-shrink-0 border border-[#333] flex items-center justify-center">
                                <i class="fas fa-video text-[10px] opacity-30"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-[14px] leading-tight line-clamp-2 mb-1 text-white" onclick="openPlayer('${id}', '${snip.title.replace(/'/g, "\\'")}')">${snip.title}</h3>
                                <p class="text-gray-500 text-[11px]">${snip.channelTitle}</p>
                                <div class="flex flex-col gap-1 mt-1 font-bold">
                                    <p class="text-gray-400 text-[11px]">
                                        <i class="fas fa-eye ml-1 opacity-50"></i> ${formatNum(stats.viewCount)} צפיות
                                    </p>
                                    <button onclick="event.stopPropagation(); copyLink('${id}')" class="mt-2 flex items-center gap-2 text-[10px] bg-[#272727] hover:bg-[#444] px-3 py-1.5 rounded-full transition w-fit mr-auto">
                                        <i class="fas fa-link"></i> העתק קישור
                                    </button>
                                </div>
                            </div>
                        </div>`;
                }
                grid.appendChild(card);
            });
        }

        async function loadHomePage() {
            setActiveNavItem('navHome');
            document.getElementById('searchInput').value = "";
            appState.pageToken = "";
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50 animate-pulse">טוען מומלצים...</div>';
            
            const titleEl = document.getElementById('sectionTitle');
            titleEl.classList.remove('hidden');
            titleEl.innerText = appState.token ? "מומלצים עבורך" : "סרטונים פופולריים בישראל";

            try {
                let url = appState.token 
                    ? `https://www.googleapis.com/youtube/v3/activities?part=snippet,contentDetails&mine=true&maxResults=12&key=${appState.apiKey}`
                    : `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&chart=mostPopular&regionCode=IL&maxResults=12&key=${appState.apiKey}`;

                const headers = appState.token ? { Authorization: `Bearer ${appState.token}` } : {};
                const res = await fetch(url, { headers });
                const data = await res.json();
                
                let videoIds = [];
                if (appState.token && data.items) {
                    videoIds = data.items
                        .map(i => i.contentDetails.upload?.videoId || i.contentDetails.playlistItem?.resourceId?.videoId)
                        .filter(Boolean);
                } else if (data.items) {
                    videoIds = data.items.map(i => i.id);
                }

                if (videoIds.length > 0) {
                    fetchAndRenderVideos(videoIds, true);
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50">לא נמצאו סרטונים.</div>';
                }
            } catch (err) { console.error(err); }
        }

        async function fetchAndRenderVideos(ids, clear) {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${ids.join(',')}&key=${appState.apiKey}`);
                const data = await res.json();
                renderResults(data.items || [], clear);
                updateChart(data.items || []);
            } catch (e) { console.error(e); }
        }

        // --- שאר הפונקציות נשארות זהות ---

        function handleLogout() {
            if (appState.token) {
                google.accounts.oauth2.revoke(appState.token, () => console.log('Revoked'));
            }
            appState.token = null;
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('userDisplay').classList.add('hidden');
            loadHomePage(); 
        }

        function initAuth() {
            try {
                appState.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: appState.clientId,
                    scope: 'https://www.googleapis.com/auth/youtube.readonly',
                    callback: (tokenResponse) => {
                        appState.token = tokenResponse.access_token;
                        updateUserInfo();
                        loadHomePage();
                    },
                });
            } catch (e) {}
        }

        function requestToken() {
            if (appState.tokenClient) appState.tokenClient.requestAccessToken();
            else toggleConfig();
        }

        async function updateUserInfo() {
            const res = await fetch(`https://www.googleapis.com/oauth2/v3/userinfo`, { headers: { Authorization: `Bearer ${appState.token}` } });
            const data = await res.json();
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('userDisplay').classList.remove('hidden');
            document.getElementById('userImg').src = data.picture;
            document.getElementById('userName').innerText = data.name;
        }

        async function loadWatchHistory() {
            if (!appState.token) return alert("יש להתחבר לחשבון גוגל.");
            setActiveNavItem('navHistory');
            document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center py-20 opacity-50">טוען...</div>';
            document.getElementById('sectionTitle').innerText = "היסטוריה";
            try {
                const url = `https://www.googleapis.com/youtube/v3/activities?part=snippet,contentDetails&mine=true&maxResults=20&key=${appState.apiKey}`;
                const res = await fetch(url, { headers: { Authorization: `Bearer ${appState.token}` } });
                const data = await res.json();
                const ids = data.items.map(i => i.contentDetails.upload?.videoId || i.contentDetails.playlistItem?.resourceId?.videoId).filter(Boolean);
                if(ids.length) fetchAndRenderVideos(ids, true);
            } catch(e){}
        }

        function formatNum(n) {
            const num = parseInt(n) || 0;
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function updateChart(items) {
            if (!appState.chart || !items.length) return;
            appState.chart.data.labels = items.slice(0, 5).map(v => v.snippet.title.substring(0, 8) + '..');
            appState.chart.data.datasets[0].data = items.slice(0, 5).map(v => parseInt(v.statistics?.likeCount || 0));
            appState.chart.update();
        }

        function initChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            if(appState.chart) appState.chart.destroy();
            appState.chart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: '#ff0000', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#555', font: { size: 8 } } } } } });
        }

        function setActiveNavItem(id) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            if(id) document.getElementById(id).classList.add('active');
        }

        async function openPlayer(id, title) {
            const modal = document.getElementById('videoModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('fullTitle').innerText = title;
            document.getElementById('playerFrame').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${id}&key=${appState.apiKey}`);
                const data = await res.json();
                if (data.items?.[0]) {
                    const item = data.items[0];
                    document.getElementById('modalDesc').innerText = item.snippet.description;
                    document.getElementById('modalStats').innerText = `${parseInt(item.statistics.viewCount).toLocaleString()} צפיות • ${new Date(item.snippet.publishedAt).toLocaleDateString('he-IL')}`;
                }
            } catch(e){}
            modal.style.display = 'flex';
        }

        function closePlayer() {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('playerFrame').src = '';
        }

        function copyLink(id) {
            const url = `https://www.youtube.com/watch?v=${id}`;
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = url;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            const toast = document.getElementById('toast');
            toast.className = "copy-toast show";
            setTimeout(() => { toast.className = "copy-toast"; }, 3000);
        }

        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(false); });
    </script>
